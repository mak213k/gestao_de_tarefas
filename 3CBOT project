import json
from datetime import datetime

ARQUIVO = "tarefas.json"
tarefas = []

def carregar_tarefas():
    """Carrega as tarefas do arquivo JSON, se existir."""
    global tarefas
    try:
        with open(ARQUIVO, "r", encoding="utf-8") as f:
            tarefas = json.load(f)
    except FileNotFoundError:
        tarefas = []

def salvar_tarefas():
    """Salva a lista de tarefas atual no arquivo JSON."""
    with open(ARQUIVO, "w", encoding="utf-8") as f:
        json.dump(tarefas, f, indent=4, ensure_ascii=False)

def mostrar_menu():
    """Exibe o menu de op√ß√µes e retorna a escolha do usu√°rio."""
    print("\n=== Sistema de Gest√£o de Tarefas - Caf√© 3 Cora√ß√µes ===")
    print("1. Adicionar tarefa")
    print("2. Listar tarefas")
    print("3. Marcar tarefa como conclu√≠da")
    print("4. Remover tarefa")
    print("5. Gerar relat√≥rio")
    print("6. Sair")
    return input("Escolha uma op√ß√£o: ")

def adicionar_tarefa():
    """Adiciona uma nova tarefa √† lista."""
    nome = input("Descri√ß√£o da tarefa: ")
    categoria = input("Categoria (ex: Estoque, Limpeza, Vendas...): ")
    prazo = input("Prazo (ex: 25/10/2025 ou deixe vazio): ")
    tarefa = {
        "nome": nome,
        "categoria": categoria,
        "prazo": prazo if prazo else "Sem prazo",
        "status": "Pendente",
        "criado_em": datetime.now().strftime("%d/%m/%Y %H:%M")
    }
    tarefas.append(tarefa)
    salvar_tarefas()
    print(f"Tarefa '{nome}' adicionada com sucesso!")

def listar_tarefas():
    """Lista todas as tarefas cadastradas."""
    if not tarefas:
        print("Nenhuma tarefa cadastrada.")
    else:
        print("\n--- Lista de Tarefas ---")
        for i, t in enumerate(tarefas, 1):
            print(f"{i}. [{t['status']}] {t['nome']} | **{t['categoria']}** | Prazo: {t['prazo']} | Criado em: {t['criado_em']}")

def marcar_concluida():
    """Marca uma tarefa como conclu√≠da pelo seu n√∫mero na lista."""
    listar_tarefas()
    if tarefas:
        try:
            num = int(input("N√∫mero da tarefa conclu√≠da: "))
            # Verifica se o n√∫mero est√° no intervalo correto
            if 0 < num <= len(tarefas):
                tarefas[num-1]["status"] = "Conclu√≠da"
                salvar_tarefas()
                print(f"Tarefa '{tarefas[num-1]['nome']}' marcada como conclu√≠da!")
            else:
                print("N√∫mero inv√°lido. O n√∫mero deve estar na lista.")
        except ValueError:
            print("Entrada inv√°lida. Por favor, digite um n√∫mero.")

def remover_tarefa():
    """Remove uma tarefa da lista pelo seu n√∫mero."""
    listar_tarefas()
    if tarefas:
        try:
            num = int(input("N√∫mero da tarefa para remover: "))
            # Verifica se o n√∫mero est√° no intervalo correto
            if 0 < num <= len(tarefas):
                removida = tarefas.pop(num-1)
                salvar_tarefas()
                print(f"Tarefa '{removida['nome']}' removida.")
            else:
                print("N√∫mero inv√°lido. O n√∫mero deve estar na lista.")
        except ValueError:
            print("Entrada inv√°lida. Por favor, digite um n√∫mero.")

def gerar_relatorio():
    """Gera e exibe um relat√≥rio resumido das tarefas."""
    print("\n=== Relat√≥rio Di√°rio ===")
    total = len(tarefas)
    concluidas = len([t for t in tarefas if t["status"] == "Conclu√≠da"])
    pendentes = total - concluidas
    
    print(f"Total de tarefas: {total}")
    print(f"‚úÖ Conclu√≠das: {concluidas}")
    print(f"‚è≥ Pendentes: {pendentes}")
    
    # Adicionando um resumo por categoria
    categorias = {}
    for t in tarefas:
        cat = t['categoria']
        status = t['status']
        if cat not in categorias:
            categorias[cat] = {"Total": 0, "Conclu√≠das": 0, "Pendentes": 0}
        categorias[cat]["Total"] += 1
        if status == "Conclu√≠da":
            categorias[cat]["Conclu√≠das"] += 1
        else:
            categorias[cat]["Pendentes"] += 1
            
    print("\n--- Por Categoria ---")
    for cat, dados in categorias.items():
        print(f"**{cat}**: Total={dados['Total']} | Conclu√≠das={dados['Conclu√≠das']} | Pendentes={dados['Pendentes']}")
        
    print("=========================")

# execu√ß√£o
if __name__ == "__main__":
    carregar_tarefas()
    while True:
        opcao = mostrar_menu()
        if opcao == '1':
            adicionar_tarefa()
        elif opcao == '2':
            listar_tarefas()
        elif opcao == '3':
            marcar_concluida()
        elif opcao == '4':
            remover_tarefa()
        elif opcao == '5':
            gerar_relatorio()
        elif opcao == '6':
            print("Encerrando... At√© logo, colaborador do Cora√ß√£oüíö‚ù§Ô∏è üíõ")
            break
        else:
            print("Op√ß√£o inv√°lida, tente novamente.")
